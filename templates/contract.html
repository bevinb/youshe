<div class="easyui-layout" data-options="fit:true,border:false">
    <div data-options="region:'center'">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'north',split:true" style="height:56px;padding:10px;">
                <form class="top-search-form">
                    <input type="hidden" name="CommunityID">
                    <input type="hidden" name="VillageID">
                    <input type="hidden" name="HouseID">
                    <table>
                        <tr>
                            <td>房源：<input class="easyui-combotree" data-options="
                    					url:'/YSService/BaseInfoService/GetTree3',
                                        method:'get',
                                        animate:true,
                                        panelHeight: 'auto',
                                        panelWidth: 300,
                                        valueField:'id',
                                        textField:'text',
                                        onClick: ys.modules.Contract.onRoomTreeChange
                             " style="width:200px;">
                            </td>
                            <td>合同编号：<input name="ContractNo" class="f1 easyui-textbox" style="width:100px"></td>
                            <td>
                                合同状态：
                                <select name="ContractStatus" class="f1 easyui-combobox">
                                    <option value="1">正常</option>
                                    <option value="2">中途结束</option>
                                    <option value="0">正常完结</option>
                                </select>
                            </td>
                            <td>业主姓名：<input name="OwnerName" class="f1 easyui-textbox" style="width:70px"></td>
                            <td>业主电话：<input name="OwnerPhone" class="f1 easyui-textbox" style="width:70px"></td>
                            <td><td><input type="button" onclick="ys.modules.Contract.loadMainData()" value="查询"></td>
                        </tr>
                    </table>
                </form>
            </div>
            <div data-options="region:'center'"><table class="main"></table></div>
            <div data-options="region:'south',split:true" style="height:300px;">
                <div class="easyui-tabs" data-options="fit:true,border:false,plain:true">
                    <div title="付款信息"><table class="sub"></table></div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="editContractDlg" class="easyui-dialog" style="width:900px;"  modal="true"
     closed="true" data-options="buttons: '#editContractDlgBtns'">
    <div style="padding:10px 60px 20px 60px">
        <form id="fm" method="post" novalidate>
            <input name="ContractID" type="hidden">
            <input name="ContractStatus" type="hidden">
            <fieldset>
                <legend>房源信息</legend>
                <table cellpadding="5">
                    <tr>
                        <td>房源:</td>
                        <td colspan=5>
                            <input name="HouseID" class="easyui-combotree" data-options="
                                url:'/YSService/BaseInfoService/GetTree3',
                                method:'get',
                                animate:true,
                                panelHeight: 'auto',
                                panelWidth: 300,
                                valueField:'id',
                                textField:'text',
                                onClick: ys.modules.Contract.onDlgRoomTreeChange,
                                required:true
                            " style="width:200px;">
                        </td>
                    </tr>
                    <tr>
                        <td>所属社区:</td>
                        <td>
                            <input name="HousInfo.CommunityName" class="easyui-textbox" style="width:150px;" readonly>
                            <span class="label">房源编号:</span><input name="lastname" class="easyui-textbox" style="width:150px;" readonly>
                        </td>
                    </tr>
                    <tr>
                        <td>小区地址:</td>
                        <td>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">区</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">路</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">弄（号）</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">栋</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">单元</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">号</span>
                        </td>
                    </tr>
                    <tr>
                        <td>所在楼层:</td>
                        <td>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">楼</span>
                            <span class="label">共</span><input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">楼</span>
                        </td>
                    </tr>
                    <tr>
                        <td>房屋面积:</td>
                        <td>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">室</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">厅</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">厨</span>
                            <input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">卫</span>
                            <span class="label">面积</span><input name="lastname" class="easyui-textbox" style="width:70px;" readonly><span class="label">平方米</span>
                        </td>
                    </tr>
                </table>
            </fieldset>
            <fieldset>
                <legend>业主信息</legend>
                <table cellpadding="5">
                    <tr>
                        <td>业主姓名:</td>
                        <td><input name="firstname" class="easyui-textbox" style="width:150px;" readonly></td>
                        <td>联系电话:</td>
                        <td><input name="lastname" class="easyui-textbox" style="width:150px;" readonly></td>
                        <td>身份证号:</td>
                        <td><input name="lastname" class="easyui-textbox" style="width:150px;" readonly></td>
                    </tr>
                    <tr>
                        <td>联系人:</td>
                        <td><input name="lastname" class="easyui-textbox" style="width:150px;" readonly></td>
                        <td>联系方式:</td>
                        <td><input name="lastname" class="easyui-textbox" style="width:150px;" readonly></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
            </fieldset>
            <fieldset>
                <legend>合同信息</legend>
                <table cellpadding="5">
                    <tr>
                        <td>合同编号:</td>
                        <td>
                            <input name="ContractNo" class="easyui-textbox" style="width:150px;" data-options="required:true">
                            <span class="label">房屋接收人:</span><input name="SendeeID" class="easyui-textbox" style="width:150px;">
                        </td>
                    </tr>
                    <tr>
                        <td>房屋租金:</td>
                        <td>
                            <input name="Rent" class="easyui-textbox" style="width:120px;" data-options="required:true">元/月
                            <span class="label" style="padding-left:18px;">房屋押金:</span><input name="Deposit" class="easyui-numberbox" style="width:120px;">元/月
                            <span class="label">付款方式:</span>押<input name="DepositCout" class="easyui-numberbox" style="width:50px;">付<input name="PayCout" class="easyui-numberbox" style="width:50px;">
                        </td>
                    </tr>
                    <tr>
                        <td>合同周期:</td>
                        <td>
                            <input name="BeginDate" class="easyui-datebox" style="width:150px;" data-options="required:true">-<input name="EndDate" class="easyui-datebox" style="width:150px;" data-options="required:true">
                            <span class="label">免租期:</span><input name="FreeDate" class="easyui-numberbox" style="width:50px;">月
                        </td>
                    </tr>
                    <tr>
                        <td>备注:</td>
                        <td>
                            <textarea name="Remarks" class="textarea easyui-validatebox" style="width:100%;" data-options="required:true"></textarea>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </form>
    </div>
</div>
<div id="editContractDlgBtns">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="ys.modules.Contract.saveMainItem()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('.easyui-dialog').dialog('close')" style="width:90px">取消</a>
</div>

<div id="editOwnerPayInfoDlg" class="easyui-dialog" style="width:600px;padding:10px 20px"  modal="true"
     closed="true" buttons="#editOwnerPayInfoDlgBtns">
    <form id="fm" method="post" novalidate>
        <input name="PayRentID" type="hidden">
        <input name="ContractID" type="hidden">
        <input name="PayStatus" type="hidden">
        <div class="fitem">
            <label>付款编号:</label>
            <input name="PayRentNo" class="easyui-textbox" data-options="required:true" readonly>
        </div>
        <div class="fitem">
            <label>应付日期:</label>
            <input name="PayRentDate" class="easyui-datebox" data-options="required:true" readonly>
        </div>
        <div class="fitem">
            <label>应付租金:</label>
            <input name="PayRent" class="easyui-numberbox" data-options="precision:2, required:true" readonly>
        </div>
        <div class="fitem">
            <label>付款方式:</label>
            <input class="easyui-combobox"
                   name="PayTypeID"
                   data-options="
                    loader: ys.loaders.payTypeLoader,
                    valueField:'PayTypeID',
                    textField:'PayTypeName',
                    required: true,
                    panelHeight:'auto'
            ">
        </div>
        <div class="fitem">
            <label>实付日期:</label>
            <input name="ActualPayRentDate" class="easyui-datebox" data-options="required:true">
        </div>
        <div class="fitem">
            <label>付款银行:</label>
            <input class="easyui-combobox"
                   name="BankID"
                   data-options="
                    loader: ys.loaders.bankListLoader,
                    valueField:'BankID',
                    textField:'BankName',
                    required: true,
                    panelHeight:'auto'
            ">
        </div>
        <div class="fitem">
            <label>付款银行卡号:</label>
            <input name="BankCardNo" class="easyui-textbox" data-options="required:true">
        </div>
        <div class="fitem">
            <label>收款人:</label>
            <input name="Payee" class="easyui-textbox" data-options="required:true">
        </div>
        <div class="fitem">
            <label>收款人银行卡号:</label>
            <input name="PayeeCardNo" class="easyui-textbox" data-options="required:true">
        </div>
        <div class="fitem">
            <label>备注:</label>
            <textarea name="Remarks" class="easyui-textarea"></textarea>
        </div>
    </form>
</div>
<div id="editOwnerPayInfoDlgBtns">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="ys.modules.Contract.saveSubData()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('.easyui-dialog').dialog('close')" style="width:90px">取消</a>
</div>

<script>
ys.modules.Contract =  (function(){
    function loadMainData(){
        var params = $.form2JsonNotNull($('#contractTab').find('.top-search-form'));
        $.ajax({
            url: '/YSService/ContractService/GetDataList',
            method: 'POST',
            data: JSON.stringify(params),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                $.each(resp, function(i,item){
                    item['BeginDate'] = $.wcfDate2JsDateStr(item['BeginDate']);
                    item['EndDate'] = $.wcfDate2JsDateStr(item['EndDate']);
                    item['CreateDate'] = $.wcfDate2JsDateStr(item['CreateDate']);
                });
                $('#contractTab').find('table.main').datagrid('loadData', {
                    total: resp.length,
                    rows: resp
                });
                $('#contractTab').find('table.sub').datagrid('loadData', { total: 0, rows: [] });
            },
            error: function (XMLHttpRequest, textStatus, thrownError) {
                alert("Error Occured!");
            }
        });
    };

    function onRoomTreeChange(node){
        var form = $('#contractTab').find('.top-search-form');
        if(node.type=='community'){
            form.form('load',{CommunityID:node.id,VillageID:'',HouseID:'',RoomID:''});
        } if(node.type=='village'){
            form.form('load',{CommunityID:'',VillageID:node.id,HouseID:'',RoomID:''});
        } if(node.type=='house'){
            form.form('load',{CommunityID:'',VillageID:'',HouseID:node.id,RoomID:''});
        }
    };

    function onDlgRoomTreeChange(node){
        var dlg = $('#editContractDlg'), form = dlg.find('form');
        if(node.type!='house'){

            form.find('.easyui-combotree').treegrid("unselect");
            return false;
        }
    };

    function saveMainItem(){
        var dlg = $('#editContractDlg'), form = dlg.find('form');
        if(!form.form('validate'))return;
        var formData =  form.serializeArray();
        var data = {};
        $.each(formData, function(i, v) {
            if (v.name == 'BeginDate' || v.name == 'EndDate' || v.name == 'CreateDate') {
                data[v.name] = $.jsDateStr2WcfDate(v.value);
            } else {
                data[v.name] = v.value;
            }
        });
        var url = '/YSService/ContractService/Add';
        if(data['ContractID'] != '0'){
            url = '/YSService/ContractService/Update';
        }
        $.ajax({
            url: url,
            type: "POST",
            data: JSON.stringify(data),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (msg) {
                loadMainData();
                dlg.dialog('close');
            },
            error: function (XMLHttpRequest, textStatus, thrownError) {
                alert("Error Occured!");
            }
        });
    };

    function cancelContract(){
        var mainTbl = $('#contractTab').find('table.main');
        if(mainTbl.datagrid('getSelections').length < 1){
            $.messager.alert('提示','请先选择要编辑的数据','info');
            return;
        }
        var data = mainTbl.datagrid('getSelected');
        $.messager.confirm('确认','确认作废该合同?',function(r){
            if (r){
                $.ajax({
                    url: '/YSService/ContractService/CancelContract',
                    method: 'POST',
                    data: JSON.stringify({ContractID: data.ContractID}),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (resp) {
                        $.messager.alert('提示','已作废合同！','success');
                        loadMainData();
                    },
                    error: function (XMLHttpRequest, textStatus, thrownError) {
                        alert("Error Occured!");
                    }
                });
            }
        });
    };

    function stopContract(){
        var mainTbl = $('#contractTab').find('table.main');
        if(mainTbl.datagrid('getSelections').length < 1){
            $.messager.alert('提示','请先选择要编辑的数据','info');
            return;
        }
        var data = mainTbl.datagrid('getSelected');
        $.messager.confirm('确认','确认终止该合同?',function(r){
            if (r){
                $.ajax({
                    url: '/YSService/ContractService/StopContract',
                    method: 'POST',
                    data: JSON.stringify({ContractID: data.ContractID}),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (resp) {
                        $.messager.alert('提示','已终止合同！','success');
                        loadMainData();
                    },
                    error: function (XMLHttpRequest, textStatus, thrownError) {
                        alert("Error Occured!");
                    }
                });
            }
        });
    };

    function loadSubData(params){
        $.ajax({
            url: '/YSService/ContractService/GetContractPayRentInfoByContractID',
            method: 'POST',
            data: JSON.stringify({ContractID:params.ContractID}),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                $.each(resp, function(i,item){
                    item['ActualPayRentDate'] = $.wcfDate2JsDateStr(item['ActualPayRentDate']);
                    item['PayRentDate'] = $.wcfDate2JsDateStr(item['PayRentDate']);
                    item['CreateDate'] = $.wcfDate2JsDateStr(item['CreateDate']);
                });
                $('#contractTab').find('table.sub').datagrid('loadData', {
                    total: resp.length,
                    rows: resp
                });
            },
            error: function (XMLHttpRequest, textStatus, thrownError) {
                alert("Error Occured!");
            }
        });
    };

    function saveSubData(){
        var dlg = $('#editOwnerPayInfoDlg'), form = dlg.find('form');
        if(!form.form('validate'))return;
        var formData =  form.serializeArray();
        var data = {};
        $.each(formData, function(i, v) {
            if (v.name == 'ActualPayRentDate' || v.name == 'PayRentDate' || v.name == 'CreateDate') {
                data[v.name] = $.jsDateStr2WcfDate(v.value);
            } else {
                data[v.name] = v.value;
            }
        });
        var url = '/YSService/ContractService/Pay';
        $.ajax({
            url: url,
            type: "POST",
            data: JSON.stringify(data),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (msg) {
                loadSubData(data);
                dlg.dialog('close');
            },
            error: function (XMLHttpRequest, textStatus, thrownError) {
                alert("Error Occured!");
            }
        });
    };

    return {
        loadMainData: loadMainData,
        onRoomTreeChange: onRoomTreeChange,
        onDlgRoomTreeChange: onDlgRoomTreeChange,
        saveMainItem: saveMainItem,
        cancelContract: cancelContract,
        stopContract: stopContract,
        loadSubData: loadSubData,
        saveSubData: saveSubData
    };
})();


window.grid.cfg.contract = {
    singleSelect:true,
    region:'center',
    rownumbers: true,
    pagination: true,
    fit: true,
    columns:[[
        {field:'ContractNo',title:'合同编号',width:100},
        {field:'ContractStatusName',title:'状态',width:100},
        {field:'HouseNo',title:'房源编号',width:100, formatter:function(v,r){return r.HousInfo.HouseNO;}},
        {field:'OwnerName',title:'业主姓名',width:100, formatter:function(v,r){return r.OwnerInfo.OwnerName;}},
        {field:'OwnerPhone',title:'业主电话',width:100, formatter:function(v,r){return r.OwnerInfo.Phone;}},
        {field:'Rent',title:'房屋租金',width:100},
        {field:'Deposit',title:'房屋押金',width:100},
        {field:'BeginDate',title:'开始时间',width:100},
        {field:'EndDate',title:'结束时间',width:100},
        {field:'SendeeName',title:'房屋接收人',width:100},
        {field:'CreateDate',title:'创建时间',width:100},
        {field:'Creater',title:'创建人',width:100}
    ]],
    onSelect:function(i, data){
        ys.modules.Contract.loadSubData(data);
    },
    toolbar: [{
        id: '',
        text: '新增',
        iconCls: 'icon-add',
        handler: function () {
            var dlg = $('#editContractDlg'), form = dlg.find('form');
            dlg.dialog('open').dialog('center').dialog('setTitle','新增合同');
            form.form('clear');
            form.form('load', {ContractID:0,ContractStatus:1})
        }
    }, "-", {
        id: '',
        text: '编辑',
        iconCls: 'icon-edit',
        handler: function () {
            var dlg = $('#editContractDlg'), form = dlg.find('form'), mainTbl = $('#contractTab').find('table.main');
            if(mainTbl.datagrid('getSelections').length < 1){
                $.messager.alert('提示','请先选择要编辑的数据','info');
                return;
            }
            dlg.dialog('open').dialog('center').dialog('setTitle','编辑合同');
            form.form('load', mainTbl.datagrid('getSelected'));
        }
    }, "-", {
        id: '',
        text: '作废',
        iconCls: 'icon-cancel',
        handler: ys.modules.Contract.cancelContract
    }, "-", {
        id: '',
        text: '终止',
        iconCls: 'icon-ok',
        handler: ys.modules.Contract.stopContract
    }, "-"]
};

window.grid.cfg.contractSub =  {
    singleSelect:true,
    rownumbers: true,
    columns:[[
        {field:'PayRentNo',title:'付款编号',width:100},
        {field:'PayRentDate',title:'应付日期',width:100},
        {field:'PayRent',title:'应付金额',width:100},
        {field:'ActualPayRentDate',title:'实付日期',width:100},
        {field:'PayTypeName',title:'付款方式',width:100},
        {field:'Payee',title:'付款人',width:100},
        {field:'Remarks',title:'备注:',width:100}
    ]],
    toolbar: [{
        id: '',
        text: '付款',
        iconCls: 'icon-edit',
        handler: function () {
            var dlg = $('#editOwnerPayInfoDlg'), form = dlg.find('form'), tbl = $('#contractTab').find('table.sub');
            if(tbl.datagrid('getSelections').length < 1){
                $.messager.alert('提示','请先选择要编辑的数据','info');
                return;
            }
            $('#editOwnerPayInfoDlg').dialog('open').dialog('center').dialog('setTitle','付款');
            form.form('load', tbl.datagrid('getSelected'));
        }
    }]
};

ys.modules.Contract.loadMainData();
</script>